{% extends "base.html" %}

{% block title %}Grille – {{ grille.nom }}{% endblock %}

{% block head %}
<style>
.grille-hero {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  border-radius: 16px;
  padding: 28px 24px;
  box-shadow: 0 12px 30px rgba(0,0,0,.15);
}
.badge-soft {
  background: rgba(255,255,255,.15);
  color: #fff;
  border: 1px solid rgba(255,255,255,.25);
  padding: 6px 10px;
  border-radius: 10px;
  font-size: .8rem;
}
.domain-card {
  border: 2px solid #f1f3f4;
  border-radius: 14px;
  background: #fff;
  transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
}
.domain-card:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,.08); border-color: #667eea; }
.domain-header { display:flex; align-items:center; justify-content:space-between; padding: 16px 18px; border-bottom: 1px solid #f5f6f7; }
.dot { width: 12px; height: 12px; border-radius: 50%; display:inline-block; margin-right: 10px; }
.ind-list { list-style:none; margin:0; padding: 12px 18px 18px; }
.ind-item { display:flex; align-items:flex-start; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #eef0f2; gap:16px; }
.ind-item:last-child { border-bottom:none; }
.ind-meta { color:#6c757d; font-size:.9rem; }
.toolbar .btn { border-radius: 10px; }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="grille-hero mb-4">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
      <div>
        <h2 class="mb-1">{{ grille.nom }}</h2>
        {% if grille.description %}
          <p class="mb-0 opacity-75">{{ grille.description }}</p>
        {% endif %}
        <div class="mt-3 d-flex flex-wrap gap-2">
          <span class="badge-soft">
            <i class="bi bi-grid-3x3-gap me-1"></i>
            {{ grille.domaines|length if grille.domaines else 0 }} domaines
          </span>
          <span class="badge-soft">
            <i class="bi bi-list-check me-1"></i>
            {% set total_indicateurs = 0 %}
            {% if grille.domaines %}
              {% for d in grille.domaines %}
                {% set total_indicateurs = total_indicateurs + (d.indicateurs|length if d.indicateurs else (d.get('indicateurs')|length if d.get('indicateurs') else 0)) %}
              {% endfor %}
            {% endif %}
            {{ total_indicateurs }} indicateurs
          </span>
          {% if grille.reference_scientifique %}
            <span class="badge-soft"><i class="bi bi-award me-1"></i>{{ grille.reference_scientifique }}</span>
          {% else %}
            <span class="badge-soft"><i class="bi bi-gear me-1"></i>Personnalisée</span>
          {% endif %}
        </div>
      </div>
      <div class="toolbar d-flex gap-2">
        <a href="{{ url_for('cotation.grilles') }}" class="btn btn-light text-primary border-0">
          <i class="bi bi-arrow-left me-1"></i>Retour aux grilles
        </a>
        {% if not grille.publique and current_user and grille.musicotherapeute_id == current_user.id %}
          <a href="{{ url_for('cotation.editer_domaines_page', grille_id=grille.id) }}" class="btn btn-warning">
            <i class="bi bi-pencil-square me-1"></i>Modifier
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  {% if not grille.domaines %}
    <div class="alert alert-info">Cette grille ne contient pas encore de domaines.</div>
  {% else %}
    <div class="row g-3">
      {% for domaine in grille.domaines %}
  {% set dom_color = (domaine.get('couleur') if domaine.get else domaine.couleur) or '#667eea' %}
      <div class="col-12">
        <div class="domain-card">
          <div class="domain-header">
            <div class="d-flex align-items-center">
              <span class="dot" data-color="{{ dom_color | e }}"></span>
              <div>
                <h5 class="mb-0">{{ domaine.get('nom', domaine.nom) }}</h5>
                {% set ddesc = domaine.get('description') if domaine.get else domaine.description %}
                {% if ddesc %}
                  <small class="text-muted">{{ ddesc }}</small>
                {% endif %}
              </div>
            </div>
            {% set dpoids = domaine.get('poids') if domaine.get else domaine.poids %}
            {% if dpoids %}
              <span class="badge rounded-pill text-bg-light"><i class="bi bi-diagram-3 me-1"></i>Poids {{ dpoids }}</span>
            {% endif %}
          </div>
          <ul class="ind-list">
            {% set inds = domaine.get('indicateurs') if domaine.get else domaine.indicateurs %}
            {% for ind in inds %}
              {% set iname = ind.get('nom', ind.nom) %}
              {% set idesc = ind.get('description') if ind.get else ind.description %}
              {% set imin  = ind.get('min', ind.get('echelle_min')) if ind.get else ind.echelle_min %}
              {% set imax  = ind.get('max', ind.get('echelle_max')) if ind.get else ind.echelle_max %}
              {% set iunit = ind.get('unite', 'points') if ind.get else (ind.unite or 'points') %}
              {% set ipoids = ind.get('poids') if ind.get else ind.poids %}
              <li class="ind-item">
                <div>
                  <strong>{{ iname }}</strong>
                  {% if idesc %}<div class="ind-meta">{{ idesc }}</div>{% endif %}
                </div>
                <div class="text-end ind-meta">
                  <div><i class="bi bi-sliders me-1"></i>{{ imin|default(0) }} – {{ imax|default(5) }} {{ iunit }}</div>
                  {% if ipoids %}<div><i class="bi bi-bar-chart-line me-1"></i>Poids {{ ipoids }}</div>{% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endfor %}
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.dot[data-color]').forEach(function(el){
    const c = el.getAttribute('data-color');
    if (c) el.style.background = c;
  });
});
</script>
{% endblock %}
