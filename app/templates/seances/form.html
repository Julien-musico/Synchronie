{% extends "base.html" %}

{% block title %}
    {% if mode == 'edit' %}
        Modifier séance - {{ patient.prenom }} {{ patient.nom }} - Synchronie
    {% else %}
        Nouvelle séance - {{ patient.prenom }} {{ patient.nom }} - Synchronie
    {% endif %}
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-0">
                    <i class="bi bi-file-music text-primary me-2"></i>
                    {% if mode == 'edit' %}
                        Modifier la séance
                    {% else %}
                        Nouvelle séance
                    {% endif %}
                </h1>
                <p class="text-muted mb-0">
                    Patient : {{ patient.prenom }} {{ patient.nom }}
                </p>
            </div>
            <a href="{{ url_for('patients.view_patient', patient_id=patient.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>
                Retour au patient
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    {% if mode == 'edit' %}
                        <i class="bi bi-pencil me-2"></i>
                        Modifier la séance
                    {% else %}
                        <i class="bi bi-plus-circle me-2"></i>
                        Enregistrer une nouvelle séance
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form action="{% if mode == 'edit' %}{{ url_for('seances.update_seance', seance_id=seance.id) }}{% else %}{{ url_for('seances.create_seance', patient_id=patient.id) }}{% endif %}" method="post" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="date_seance" class="form-label">Date et heure de la séance</label>
                                <input type="datetime-local" class="form-control" id="date_seance" name="date_seance" 
                                       value="{% if seance %}{{ seance.date_seance.strftime('%Y-%m-%dT%H:%M') }}{% elif data %}{{ data.date_seance }}{% endif %}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="type_seance" class="form-label">Type de séance</label>
                                <select class="form-select" id="type_seance" name="type_seance">
                                    <option value="">Sélectionner...</option>
                                    {% set current_type = seance.type_seance if seance else (data.type_seance if data else '') %}
                                    <option value="musicothérapie" {{ 'selected' if current_type == 'musicothérapie' else '' }}>Musicothérapie</option>
                                    <option value="improvisation" {{ 'selected' if current_type == 'improvisation' else '' }}>Improvisation</option>
                                    <option value="écoute" {{ 'selected' if current_type == 'écoute' else '' }}>Écoute musicale</option>
                                    <option value="chant" {{ 'selected' if current_type == 'chant' else '' }}>Chant</option>
                                    <option value="instrument" {{ 'selected' if current_type == 'instrument' else '' }}>Pratique instrumentale</option>
                                    <option value="autre" {{ 'selected' if current_type == 'autre' else '' }}>Autre</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="duree_minutes" class="form-label">Durée (minutes)</label>
                                <input type="number" class="form-control" id="duree_minutes" name="duree_minutes" min="1" max="180" 
                                       value="{% if seance %}{{ seance.duree_minutes or '' }}{% elif data %}{{ data.duree_minutes or '' }}{% endif %}" placeholder="45">
                            </div>
                        </div>
            {% if mode == 'create' and (not grille) and grilles_disponibles %}
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="assign_grille_id" class="form-label">Grille de cotation</label>
                                <select class="form-select" id="assign_grille_id" name="assign_grille_id">
                                    <option value="">Aucune (vous pourrez en ajouter plus tard)</option>
                                    {% for g in grilles_disponibles %}
                                        <option value="{{ g.id }}">{{ g.nom }}</option>
                                    {% endfor %}
                                </select>
                <div class="form-text">Aucune grille n'est assignée à ce patient. Choisissez-en une pour afficher immédiatement la cotation.</div>
                            </div>
                        </div>
                        {% endif %}
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="score_engagement" class="form-label">Score d'engagement (1-10)</label>
                                {% set current_score = seance.score_engagement if seance else (data.score_engagement if data else 5) %}
                                <input type="range" class="form-range" id="score_engagement" name="score_engagement" min="1" max="10" step="1" value="{{ current_score }}">
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">1</small>
                                    <small id="score_value" class="fw-bold">{{ current_score }}</small>
                                    <small class="text-muted">10</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="objectifs_seance" class="form-label">Objectifs de la séance</label>
                        <textarea class="form-control" id="objectifs_seance" name="objectifs_seance" rows="3" 
                                  placeholder="Décrire les objectifs spécifiques de cette séance...">{% if seance %}{{ seance.objectifs_seance or '' }}{% elif data %}{{ data.objectifs_seance or '' }}{% endif %}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="activites_realisees" class="form-label">Activités réalisées</label>
                        <textarea class="form-control" id="activites_realisees" name="activites_realisees" rows="4" 
                                  placeholder="Décrire les activités qui ont été réalisées pendant la séance...">{% if seance %}{{ seance.activites_realisees or '' }}{% elif data %}{{ data.activites_realisees or '' }}{% endif %}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="observations" class="form-label">Observations et notes</label>
                        <textarea class="form-control" id="observations" name="observations" rows="4" 
                                  placeholder="Observations comportementales, réactions du patient, points d'attention...">{% if seance %}{{ seance.observations or '' }}{% elif data %}{{ data.observations or '' }}{% endif %}</textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fichier_audio" class="form-label">
                                    <i class="bi bi-mic me-1"></i>
                                    Enregistrement audio
                                </label>
                                <div class="d-flex gap-2">
                                    <input type="file" class="form-control" id="fichier_audio" name="fichier_audio" 
                                           accept="audio/*,.mp3,.wav,.m4a,.flac,.ogg">
                                    {% if mode == 'edit' and seance %}
                                    <button type="button" class="btn btn-success" id="inline-upload-btn" disabled>
                                        <i class="bi bi-upload me-1"></i> Transcrire
                                    </button>
                                    {% endif %}
                                </div>
                                {% if seance and seance.transcription_audio %}
                                    <div class="form-text text-success mt-1">
                                        <i class="bi bi-check-circle me-1"></i>
                                        Séance déjà transcrite
                                    </div>
                                {% else %}
                                    <div class="form-text mt-1">
                                        Formats supportés : MP3, WAV, M4A, FLAC, OGG (max 25 MB)
                                        <br><small class="text-muted">{% if mode == 'edit' %}Sélectionnez un fichier puis cliquez sur Transcrire{% else %}La transcription pourra être lancée après la création{% endif %}</small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fichier_video" class="form-label">Enregistrement vidéo (optionnel)</label>
                                <input type="file" class="form-control" id="fichier_video" name="fichier_video" accept="video/*">
                                {% if seance and seance.fichier_video %}
                                    <div class="form-text">
                                        <i class="bi bi-file-earmark-play text-info me-1"></i>
                                        Fichier actuel : {{ seance.fichier_video }}
                                    </div>
                                {% else %}
                                    <div class="form-text">Formats acceptés : MP4, AVI, MOV</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Statut de transcription -->
                    <div id="transcription-status" class="alert alert-info" style="display: none;">
                        <div class="d-flex align-items-center mb-2">
                            <div class="spinner-border spinner-border-sm text-info me-2" role="status">
                                <span class="visually-hidden">Transcription...</span>
                            </div>
                            <span id="transcription-text">Transcription en cours...</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div id="transcription-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-end small mt-1"><span id="transcription-percent">0%</span></div>
                    </div>

                    <!-- Hidden fields to carry temp results in create mode -->
                    {% if mode == 'create' %}
                    <input type="hidden" id="transcription_temp_text" name="transcription_temp_text" />
                    <input type="hidden" id="synthese_temp_text" name="synthese_temp_text" />
                    {% endif %}

                    <!-- Zone de transcription (si disponible) -->
                    {% if seance and seance.transcription_audio %}
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-file-text me-1"></i>
                            Transcription audio
                        </label>
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <div class="transcription-text" style="max-height: 200px; overflow-y: auto;">
                                    {{ seance.transcription_audio }}
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="expandTranscription()">
                                        <i class="bi bi-arrows-fullscreen me-1"></i>
                                        Voir en plein écran
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Preview zone for temp transcription in create mode -->
                    {% if mode == 'create' %}
                    <div id="transcription-preview" class="mb-3" style="display:none;">
                        <label class="form-label">
                            <i class="bi bi-file-text me-1"></i>
                            Transcription (prévisualisation)
                        </label>
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <div id="transcription-preview-text" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap;"></div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Zone de synthèse IA (si disponible) -->
                    {% if seance and seance.synthese_ia %}
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-robot me-1"></i>
                            Synthèse thérapeutique IA
                        </label>
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <div class="synthese-text" style="max-height: 200px; overflow-y: auto;">
                                    {{ seance.synthese_ia|safe|replace('\n', '<br>')|replace('**', '<strong>')|replace('**', '</strong>') }}
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="expandSynthese()">
                                        <i class="bi bi-arrows-fullscreen me-1"></i>
                                        Voir en plein écran
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Preview zone for temp synthesis in create mode -->
                    {% if mode == 'create' %}
                    <div id="synthese-preview" class="mb-3" style="display:none;">
                        <label class="form-label">
                            <i class="bi bi-robot me-1"></i>
                            Synthèse thérapeutique IA (prévisualisation)
                        </label>
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <div id="synthese-preview-text" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap;"></div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <hr class="my-4">

                    <!-- Section de cotation optionnelle (création ET modification) -->
                    {% if grille %}
                    <div class="cotation-section">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-clipboard-check text-success me-2"></i>
                                Cotation {% if mode == 'edit' %}(mise à jour){% else %}(optionnelle){% endif %}
                            </h5>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="toggle-cotation">
                                <i class="bi bi-eye-slash me-1"></i>
                                Masquer
                            </button>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Grille : {{ grille.nom }}</strong> - {% if mode == 'edit' %}Vous pouvez mettre à jour la cotation de cette séance.{% else %}Vous pouvez coter cette séance directement lors de sa création.{% endif %}
                        </div>

                        <div id="cotation-content">
                            {% if grille.domaines %}
                                {% for domaine in grille.domaines %}
                                    <div class="domaine-section mb-4">
                                        <h6 class="text-primary border-bottom pb-2">
                                            <i class="bi bi-folder me-2"></i>{{ domaine.get('nom', 'Domaine') }}
                                        </h6>
                                        {% if domaine.get('description') %}
                                            <p class="text-muted small mb-3">{{ domaine.description }}</p>
                                        {% endif %}
                                        
                                        {% if domaine.get('indicateurs') %}
                                            <div class="row">
                                                {% for indicateur in domaine.indicateurs %}
                                                    <div class="col-md-6 mb-3">
                                                        <div class="card border-0 bg-light">
                                                            <div class="card-body p-3">
                                                                <label class="form-label fw-bold small">
                                                                    {{ indicateur.get('nom', 'Indicateur') }}
                                                                </label>
                                                                {% if indicateur.get('description') %}
                                                                    <p class="small text-muted mb-2">{{ indicateur.description[:60] }}{% if indicateur.description|length > 60 %}...{% endif %}</p>
                                                                {% endif %}
                                                                
                                                                <div class="slider-container">
                                                                    <input type="range" 
                                                                           class="form-range cotation-slider-form" 
                                                                           min="0" 
                                                                           max="5" 
                                                                           step="1" 
                                                                           value="0"
                                                                           name="cotation_score_{{ domaine.get('nom', 'domaine')|replace(' ', '_') }}_{{ indicateur.get('nom', 'indicateur')|replace(' ', '_') }}"
                                                                           data-indicator="{{ indicateur.get('nom', 'indicateur') }}">
                                                                    <div class="d-flex justify-content-between small text-muted mt-1">
                                                                        <span>0</span>
                                                                        <span>3</span>
                                                                        <span>5</span>
                                                                    </div>
                                                                    <div class="text-center mt-1">
                                                                        <span class="badge bg-secondary score-display-form">0 - Non évalué</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                                
                                <!-- Zone observations de cotation -->
                                <div class="mb-3">
                                    <label for="cotation_observations" class="form-label">
                                        <i class="bi bi-chat-text me-1"></i>
                                        Observations de cotation
                                    </label>
                                    <textarea class="form-control" 
                                              id="cotation_observations" 
                                              name="cotation_observations" 
                                              rows="3"
                                              placeholder="Notes spécifiques sur l'évaluation de cette séance..."></textarea>
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    La grille assignée n'a pas de domaines configurés.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-light">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Aucune grille de cotation</strong> - Sélectionnez une grille dans le menu plus haut pour afficher la cotation ici.
                    </div>
                    <!-- Dynamic cotation placeholder (create mode) -->
                    {% if mode == 'create' %}
                    <div id="dynamic-cotation-root"></div>
                    {% endif %}
                    {% endif %}

                    <hr class="my-4">

                    <div class="d-flex justify-content-between align-items-center gap-2 mb-2">
                        <div>
                            <button type="button" class="btn btn-outline-success" id="btn-generate-synthese">
                                <i class="bi bi-magic me-1"></i>
                                Générer synthèse
                            </button>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('patients.view_patient', patient_id=patient.id) }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-2"></i>
                                Annuler
                            </a>
                            <button type="submit" class="btn btn-primary">
                                {% if mode == 'edit' %}
                                    <i class="bi bi-save me-2"></i>
                                    Mettre à jour
                                {% else %}
                                    <i class="bi bi-save me-2"></i>
                                    Enregistrer la séance
                                {% endif %}
                            </button>
                        </div>
                    </div>
                    
                </form>
            </div>
        </div>
    </div>

    <!-- Informations du patient -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 pb-0">
                <h5 class="card-title mb-0">
                    <i class="bi bi-person text-primary me-2"></i>
                    Informations patient
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                        <i class="bi bi-person fs-2 text-primary"></i>
                    </div>
                    <h6 class="mb-1">{{ patient.prenom }} {{ patient.nom }}</h6>
                    {% if patient.pathologie %}
                        <span class="badge bg-warning text-dark">{{ patient.pathologie }}</span>
                    {% endif %}
                </div>

                {% if patient.objectifs_therapeutiques %}
                <div class="mb-3">
                    <h6 class="text-muted mb-2">Objectifs thérapeutiques</h6>
                    <p class="small mb-0">{{ patient.objectifs_therapeutiques|truncate(150) }}</p>
                </div>
                {% endif %}

                <div class="mb-3">
                    <h6 class="text-muted mb-2">Statistiques</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <small>Séances réalisées :</small>
                        <small class="fw-bold">{{ patient.seances|length }}</small>
                    </div>
                    {% if patient.seances %}
                        {% set derniere_seance = patient.seances|sort(attribute='date_seance', reverse=true)|first %}
                        <div class="d-flex justify-content-between">
                            <small>Dernière séance :</small>
                            <small class="fw-bold">{{ derniere_seance.date_seance.strftime('%d/%m/%Y') }}</small>
                        </div>
                    {% endif %}
                </div>

                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <small>Cette séance sera automatiquement associée à ce patient.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mise à jour dynamique du score d'engagement
    const scoreRange = document.getElementById('score_engagement');
    const scoreValue = document.getElementById('score_value');
    
    scoreRange.addEventListener('input', function() {
        scoreValue.textContent = this.value;
    });

    // Initialiser la date et heure actuelles
    const now = new Date();
    const dateTimeLocal = now.getFullYear() + '-' + 
                         String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(now.getDate()).padStart(2, '0') + 'T' + 
                         String(now.getHours()).padStart(2, '0') + ':' + 
                         String(now.getMinutes()).padStart(2, '0');
    const dateInput = document.getElementById('date_seance');
    if (dateInput && !dateInput.value) {
        dateInput.value = dateTimeLocal;
    }
    
    // Gestion de l'affichage/masquage de la section de cotation
    const toggleButton = document.getElementById('toggle-cotation');
    const cotationContent = document.getElementById('cotation-content');
    
    if (toggleButton && cotationContent) {
        toggleButton.addEventListener('click', function() {
            const isVisible = cotationContent.style.display !== 'none';
            
            if (isVisible) {
                cotationContent.style.display = 'none';
                toggleButton.innerHTML = '<i class="bi bi-eye me-1"></i>Afficher';
                toggleButton.classList.remove('btn-outline-secondary');
                toggleButton.classList.add('btn-outline-primary');
            } else {
                cotationContent.style.display = 'block';
                toggleButton.innerHTML = '<i class="bi bi-eye-slash me-1"></i>Masquer';
                toggleButton.classList.remove('btn-outline-primary');
                toggleButton.classList.add('btn-outline-secondary');
            }
        });
    }
    
    // Gestion des curseurs de cotation
    const cotationSliders = document.querySelectorAll('.cotation-slider-form');
    
    cotationSliders.forEach(slider => {
        const scoreDisplay = slider.closest('.slider-container').querySelector('.score-display-form');
        
        function updateScoreDisplay(value) {
            const labels = {
                0: '0 - Non évalué',
                1: '1 - Très faible',
                2: '2 - Faible', 
                3: '3 - Modéré',
                4: '4 - Bon',
                5: '5 - Excellent'
            };
            
            const colors = {
                0: 'bg-secondary',
                1: 'bg-danger',
                2: 'bg-warning',
                3: 'bg-info',
                4: 'bg-primary',
                5: 'bg-success'
            };
            
            // Retirer toutes les classes de couleur
            scoreDisplay.className = 'badge score-display-form';
            scoreDisplay.classList.add(colors[value]);
            scoreDisplay.textContent = labels[value];
        }
        
        // Initialiser l'affichage
        updateScoreDisplay(slider.value);
        
        // Mettre à jour en temps réel
        slider.addEventListener('input', function() {
            updateScoreDisplay(this.value);
        });
    });
    
    // Animation des curseurs
    cotationSliders.forEach(slider => {
        slider.addEventListener('input', function() {
            this.style.background = `linear-gradient(to right, #007bff 0%, #007bff ${(this.value/5)*100}%, #e9ecef ${(this.value/5)*100}%, #e9ecef 100%)`;
        });
        
        // Initialiser l'apparence
        slider.style.background = `linear-gradient(to right, #007bff 0%, #007bff 0%, #e9ecef 0%, #e9ecef 100%)`;
    });
    
    // Validation du formulaire avec information sur la cotation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const hasCotation = Array.from(cotationSliders).some(slider => parseInt(slider.value) > 0);
            
            if (hasCotation) {
                const confirmSubmit = confirm('Vous avez commencé une cotation. Voulez-vous créer la séance avec cette cotation ?');
                if (!confirmSubmit) {
                    e.preventDefault();
                    return;
                }
            }
        });
    }
    
    // Gestion de l'upload audio et inline transcription (mode édition)
    const audioInput = document.getElementById('fichier_audio');
    const transcriptionStatus = document.getElementById('transcription-status');
    const transcriptionText = document.getElementById('transcription-text');
    const inlineUploadBtn = document.getElementById('inline-upload-btn');

    function validateAudioFile(file, inputEl) {
        if (!file) return false;
        if (file.size > 25 * 1024 * 1024) {
            alert('Fichier trop volumineux. Taille maximale : 25 MB');
            if (inputEl) inputEl.value = '';
            return false;
        }
        const isValidName = /\.(mp3|wav|m4a|flac|ogg|webm)$/i.test(file.name || '');
        if (!isValidName) {
            alert('Format de fichier non supporté. Utilisez : MP3, WAV, M4A, FLAC, OGG');
            if (inputEl) inputEl.value = '';
            return false;
        }
        return true;
    }

    if (audioInput) {
        audioInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (validateAudioFile(file, e.target) && inlineUploadBtn) {
                inlineUploadBtn.disabled = false;
            } else if (inlineUploadBtn) {
                inlineUploadBtn.disabled = true;
            }

            // Auto-transcription en mode création
            const isCreate = '{{ mode }}' === 'create';
            if (isCreate && file && validateAudioFile(file, e.target)) {
                startTempTranscription(file);
            }
        });
    }

    // Dynamic cotation rendering when choosing a grille in create mode without pre-assigned grille
    const assignSelect = document.getElementById('assign_grille_id');
    const dynamicRoot = document.getElementById('dynamic-cotation-root');
    if (assignSelect && dynamicRoot) {
        assignSelect.addEventListener('change', function() {
            const gid = this.value;
            // Show a small loading indicator
            dynamicRoot.innerHTML = '<div class="alert alert-light"><div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2"></div>Chargement de la grille...</div></div>';
            if (!gid) return;
            // Fetch domaines of selected grille
            fetch(`/grilles/api/${gid}/domaines`)
                .then(r => r.json())
                .then(data => {
                    if (!data.success) throw new Error(data.message || 'Erreur chargement grille');
                    const domaines = data.domaines || [];
                    if (!domaines.length) return;
                    // Build cotation section with sliders (0..5 like the simplified UI)
                    const section = document.createElement('div');
                    section.className = 'cotation-section';
            const grilleNom = (data.grille && data.grille.nom) ? data.grille.nom : 'Sélectionnée';
            section.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-clipboard-check text-success me-2"></i>
                                Cotation (optionnelle)
                            </h5>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="toggle-cotation-dyn">
                                <i class="bi bi-eye-slash me-1"></i>
                                Masquer
                            </button>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                <strong>Grille : ${grilleNom}</strong> - Vous pouvez coter cette séance dès maintenant.
                        </div>
                        <div id="cotation-content-dyn"></div>
                        <div class="mb-3 mt-3">
                            <label for="cotation_observations" class="form-label">
                                <i class="bi bi-chat-text me-1"></i>
                                Observations de cotation
                            </label>
                            <textarea class="form-control" id="cotation_observations" name="cotation_observations" rows="3" placeholder="Notes spécifiques sur l'évaluation de cette séance..."></textarea>
                        </div>
                    `;
                    dynamicRoot.appendChild(section);
                    // Populate domaines -> indicateurs
                    const container = section.querySelector('#cotation-content-dyn');
                    domaines.forEach(d => {
                        const dom = document.createElement('div');
                        dom.className = 'domaine-section mb-4';
                        const domName = d.nom || 'Domaine';
                        const domDesc = d.description || '';
                        const indicateurs = d.indicateurs || [];
                        dom.innerHTML = `
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="bi bi-folder me-2"></i>${domName}
                            </h6>
                            ${domDesc ? `<p class="text-muted small mb-3">${domDesc}</p>` : ''}
                            <div class="row"></div>
                        `;
                        const row = dom.querySelector('.row');
                        indicateurs.forEach(ind => {
                            const indName = ind.nom || 'Indicateur';
                            const indDesc = ind.description || '';
                            // Normalize names to match server parsing pattern cotation_score_<domaine>_<indicateur>
                            const nameAttr = `cotation_score_${(domName || 'domaine').replace(/\s+/g,'_')}_${(indName || 'indicateur').replace(/\s+/g,'_')}`;
                            const col = document.createElement('div');
                            col.className = 'col-md-6 mb-3';
                            col.innerHTML = `
                                <div class="card border-0 bg-light">
                                    <div class="card-body p-3">
                                        <label class="form-label fw-bold small">${indName}</label>
                                        ${indDesc ? `<p class="small text-muted mb-2">${indDesc.length > 60 ? indDesc.slice(0,60)+'...' : indDesc}</p>` : ''}
                                        <div class="slider-container">
                                            <input type="range" class="form-range cotation-slider-form" min="0" max="5" step="1" value="0" name="${nameAttr}">
                                            <div class="d-flex justify-content-between small text-muted mt-1">
                                                <span>0</span><span>3</span><span>5</span>
                                            </div>
                                            <div class="text-center mt-1">
                                                <span class="badge bg-secondary score-display-form">0 - Non évalué</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
                            row.appendChild(col);
                        });
                        container.appendChild(dom);
                    });
                    // Activate slider behaviors on dynamically added inputs
                    const newSliders = section.querySelectorAll('.cotation-slider-form');
                    newSliders.forEach(slider => {
                        const scoreDisplay = slider.closest('.slider-container').querySelector('.score-display-form');
                        const updateScoreDisplay = (value) => {
                            const labels = {0:'0 - Non évalué',1:'1 - Très faible',2:'2 - Faible',3:'3 - Modéré',4:'4 - Bon',5:'5 - Excellent'};
                            const colors = {0:'bg-secondary',1:'bg-danger',2:'bg-warning',3:'bg-info',4:'bg-primary',5:'bg-success'};
                            scoreDisplay.className = 'badge score-display-form ' + (colors[value] || 'bg-secondary');
                            scoreDisplay.textContent = labels[value] || '0 - Non évalué';
                        };
                        updateScoreDisplay(parseInt(slider.value,10) || 0);
                        slider.addEventListener('input', function(){
                            updateScoreDisplay(parseInt(this.value,10) || 0);
                            this.style.background = `linear-gradient(to right, #007bff 0%, #007bff ${(+this.value/5)*100}%, #e9ecef ${(+this.value/5)*100}%, #e9ecef 100%)`;
                        });
                        slider.style.background = 'linear-gradient(to right, #007bff 0%, #007bff 0%, #e9ecef 0%, #e9ecef 100%)';
                    });
                    // Toggle behavior
                    const toggleDyn = document.getElementById('toggle-cotation-dyn');
                    const contentDyn = document.getElementById('cotation-content-dyn');
                    if (toggleDyn && contentDyn) {
                        toggleDyn.addEventListener('click', function(){
                            const hidden = contentDyn.style.display === 'none';
                            contentDyn.style.display = hidden ? 'block' : 'none';
                            this.innerHTML = hidden ? '<i class="bi bi-eye-slash me-1"></i>Masquer' : '<i class="bi bi-eye me-1"></i>Afficher';
                            this.classList.toggle('btn-outline-primary');
                            this.classList.toggle('btn-outline-secondary');
                        });
                    }
                })
                .catch(err => {
                    console.error('Erreur chargement grille:', err);
                    dynamicRoot.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>Impossible de charger la grille sélectionnée. Réessayez.</div>';
                });
        });
    }

    if (inlineUploadBtn && audioInput) {
        inlineUploadBtn.addEventListener('click', function() {
            const file = audioInput.files && audioInput.files[0];
            if (!validateAudioFile(file, audioInput)) return;

            // Afficher statut
            if (transcriptionStatus && transcriptionText) {
                transcriptionStatus.style.display = 'block';
                transcriptionStatus.classList.remove('alert-success','alert-warning','alert-danger');
                transcriptionStatus.classList.add('alert-info');
                transcriptionText.textContent = 'Transcription en cours...';
            }

            // Préparer requête
            const formData = new FormData();
            formData.append('audio_file', file);

            // Endpoint inline pour transcription seule
            const seanceId = '{{ seance.id if seance else "" }}';
            fetch(`/audio/transcribe-only/${seanceId}`, {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    if (transcriptionStatus && transcriptionText) {
                        transcriptionStatus.classList.remove('alert-info');
                        transcriptionStatus.classList.add('alert-success');
                        transcriptionText.textContent = 'Transcription terminée ! Rechargement...';
                    }
                    setTimeout(() => window.location.reload(), 1200);
                } else {
                    throw new Error(data.message || 'Erreur inconnue');
                }
            })
            .catch(err => {
                console.error(err);
                if (transcriptionStatus && transcriptionText) {
                    transcriptionStatus.classList.remove('alert-info');
                    transcriptionStatus.classList.add('alert-danger');
                    transcriptionText.textContent = `Erreur de transcription: ${err.message}`;
                }
            })
            .finally(() => {
                if (inlineUploadBtn) inlineUploadBtn.disabled = true;
            });
        });
    }
});

// Fonctions pour l'affichage en plein écran
function expandTranscription() {
    const transcription = document.querySelector('.transcription-text').textContent;
    showModal('Transcription complète', transcription);
}

function expandSynthese() {
    const synthese = document.querySelector('.synthese-text').innerHTML;
    showModal('Synthèse thérapeutique IA', synthese);
}

function showModal(title, content) {
    // Créer une modal Bootstrap dynamiquement
    const modalHtml = `
        <div class="modal fade" id="contentModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div style="white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6;">
                            ${content}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Supprimer l'ancienne modal si elle existe
    const existingModal = document.getElementById('contentModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Ajouter la nouvelle modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Afficher la modal
    const modal = new bootstrap.Modal(document.getElementById('contentModal'));
    modal.show();
}

// Fonction pour démarrer la transcription en arrière-plan après sauvegarde
function startBackgroundTranscription(seanceId, audioFile) {
    const transcriptionStatus = document.getElementById('transcription-status');
    const transcriptionText = document.getElementById('transcription-text');
    
    if (!transcriptionStatus || !audioFile) return;
    
    // Afficher le statut de transcription
    transcriptionStatus.style.display = 'block';
    transcriptionText.textContent = 'Transcription en cours en arrière-plan...';
    
    // Préparer les données pour l'upload
    const formData = new FormData();
    formData.append('audio_file', audioFile);
    
    // Lancer la transcription en AJAX
    fetch(`/audio/transcribe-only/${seanceId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            transcriptionText.textContent = 'Transcription terminée ! Rechargez la page pour voir le résultat.';
            transcriptionStatus.classList.remove('alert-info');
            transcriptionStatus.classList.add('alert-success');
            
            // Optionnel : recharger automatiquement après quelques secondes
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            transcriptionText.textContent = `Erreur de transcription: ${data.message}`;
            transcriptionStatus.classList.remove('alert-info');
            transcriptionStatus.classList.add('alert-warning');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        transcriptionText.textContent = 'Erreur de connexion lors de la transcription';
        transcriptionStatus.classList.remove('alert-info');
        transcriptionStatus.classList.add('alert-danger');
    });
}

// Temp transcription (create mode) with simulated progress
function startTempTranscription(file) {
    const status = document.getElementById('transcription-status');
    const text = document.getElementById('transcription-text');
    const bar = document.getElementById('transcription-progress');
    const pct = document.getElementById('transcription-percent');
    const preview = document.getElementById('transcription-preview');
    const previewText = document.getElementById('transcription-preview-text');
    const hiddenInput = document.getElementById('transcription_temp_text');

    if (!status || !bar || !pct) return;

    status.style.display = 'block';
    status.classList.remove('alert-success','alert-warning','alert-danger');
    status.classList.add('alert-info');
    text.textContent = 'Transcription en cours...';
    bar.style.width = '0%';
    pct.textContent = '0%';

    let progress = 0;
    const timer = setInterval(() => {
        // Simuler une progression jusqu'à 90%
        progress = Math.min(progress + Math.random() * 12, 90);
        bar.style.width = progress.toFixed(0) + '%';
        pct.textContent = progress.toFixed(0) + '%';
    }, 400);

    const formData = new FormData();
    formData.append('audio_file', file);

    fetch('/audio/transcribe-temp', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                clearInterval(timer);
                bar.style.width = '100%';
                pct.textContent = '100%';
                status.classList.remove('alert-info');
                status.classList.add('alert-success');
                text.textContent = 'Transcription terminée';

                if (hiddenInput) hiddenInput.value = data.transcription || '';
                if (preview && previewText) {
                    preview.style.display = 'block';
                    previewText.textContent = data.transcription || '';
                }
            } else {
                throw new Error(data.message || 'Erreur inconnue');
            }
        })
        .catch(err => {
            clearInterval(timer);
            status.classList.remove('alert-info');
            status.classList.add('alert-danger');
            text.textContent = 'Erreur de transcription: ' + err.message;
        });
}

// Generate synthesis button
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('btn-generate-synthese');
    if (!btn) return;

    btn.addEventListener('click', function() {
        const mode = '{{ mode }}';
        const observations = document.getElementById('observations')?.value || '';
        const objectifs = document.getElementById('objectifs_seance')?.value || '';
        const activites = document.getElementById('activites_realisees')?.value || '';
        const transcrTemp = document.getElementById('transcription_temp_text')?.value || '';
        const synthHidden = document.getElementById('synthese_temp_text');

        // Afficher un statut
        const status = document.getElementById('transcription-status');
        const text = document.getElementById('transcription-text');
        if (status && text) {
            status.style.display = 'block';
            status.classList.remove('alert-success','alert-warning','alert-danger');
            status.classList.add('alert-info');
            text.textContent = 'Génération de la synthèse...';
        }

    if (mode === 'edit') {
            const seanceId = '{{ seance.id if seance else "" }}';
            fetch(`/audio/generate-with-context/${seanceId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    use_transcription: true,
                    // Always provide a fallback text; backend will use transcription if available
                    text: [observations, objectifs, activites].filter(Boolean).join('\n\n')
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    if (status && text) {
                        status.classList.remove('alert-info');
                        status.classList.add('alert-success');
                        text.textContent = 'Synthèse générée';
                    }
                    // Recharger pour afficher la synthèse persistée
                    setTimeout(() => window.location.reload(), 800);
                } else {
                    throw new Error(data.message || 'Erreur inconnue');
                }
            })
            .catch(err => {
                if (status && text) {
                    status.classList.remove('alert-info');
                    status.classList.add('alert-danger');
                    text.textContent = 'Erreur de synthèse: ' + err.message;
                }
            });
        } else {
            // create mode: generate temp and preview
            const patientInfoEl = document.getElementById('patient-info-json');
            let patientInfo = { prenom: '', pathologie: '', objectifs_therapeutiques: '' };
            if (patientInfoEl && patientInfoEl.textContent) {
                try { patientInfo = JSON.parse(patientInfoEl.textContent); } catch(e) { /* ignore */ }
            }
            const sessionContext = {
                objectifs_seance: objectifs,
                activites_realisees: activites,
                observations: observations
            };
            const textToUse = transcrTemp || [observations, objectifs, activites].filter(Boolean).join('\n\n');
            fetch('/audio/generate-temp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: textToUse, patient_info: patientInfo, session_context: sessionContext })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    if (status && text) {
                        status.classList.remove('alert-info');
                        status.classList.add('alert-success');
                        text.textContent = 'Synthèse générée (prévisualisation)';
                    }
                    const prev = document.getElementById('synthese-preview');
                    const prevText = document.getElementById('synthese-preview-text');
                    if (prev && prevText) {
                        prev.style.display = 'block';
                        prevText.textContent = data.analysis || '';
                    }
                    if (synthHidden) synthHidden.value = data.analysis || '';
                } else {
                    throw new Error(data.message || 'Erreur inconnue');
                }
            })
            .catch(err => {
                if (status && text) {
                    status.classList.remove('alert-info');
                    status.classList.add('alert-danger');
                    text.textContent = 'Erreur de synthèse: ' + err.message;
                }
            });
        }
    });
});
</script>

<!-- Patient info JSON for JS consumption -->
<script id="patient-info-json" type="application/json">{{ {'prenom': patient.prenom, 'pathologie': patient.pathologie or '', 'objectifs_therapeutiques': patient.objectifs_therapeutiques or ''} | tojson }}</script>

<style>
.cotation-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
}

.domaine-section {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.slider-container {
    margin-top: 10px;
}

.cotation-slider-form {
    width: 100%;
    height: 6px;
    border-radius: 5px;
    outline: none;
    transition: background 0.3s ease;
}

.cotation-slider-form::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.cotation-slider-form::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.score-display-form {
    min-width: 120px;
    font-size: 0.8em;
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transition: all 0.2s ease;
}
</style>
{% endblock %}
