<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}🎵 Synchronie{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); box-shadow: 0 2px 12px rgba(76,76,120,0.08);">
        <div class="container align-items-center">
            <a class="navbar-brand d-flex align-items-center fw-bold" href="{{ url_for('main.index') }}">
                <img src="{{ url_for('static', filename='img/wave_resonance.svg') }}" alt="Onde sonore" style="height:38px; margin-right:12px; filter: drop-shadow(0 2px 6px #4F8EF7);">
                <span style="font-size:1.7rem; letter-spacing:1px; color:#fff; text-shadow:0 2px 8px #764ba2;">Synchronie</span>
            </a>
            <div class="d-none d-lg-block ms-auto">
                <img src="{{ url_for('static', filename='img/wave_resonance.svg') }}" alt="Onde résonance" style="height:32px; opacity:0.7; margin-left:16px;">
            </div>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center" href="{{ url_for('main.dashboard') }}">
                            <img src="{{ url_for('static', filename='img/wave_resonance.svg') }}" alt="Dashboard" style="height:22px; margin-right:7px;">
                            <span>Tableau de bord</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center" href="{{ url_for('patients.list_patients') }}">
                            <i class="bi bi-people me-1" style="font-size:1.3rem;color:#fff;"></i>
                            <span>Patients</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-file-music me-1" style="font-size:1.3rem;color:#fff;"></i>
                            <span>Séances</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('seances.list_seances') }}"><i class="bi bi-list me-2"></i>Toutes les séances</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-upload me-2"></i>Traiter enregistrement</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-graph-up me-1" style="font-size:1.3rem;color:#fff;"></i>
                            <span>Analyses</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('cotation.analyses_overview') }}"><i class="bi bi-bar-chart me-2"></i>Statistiques globales</a></li>
                            <li><a class="dropdown-item" href="#" onclick="chargerPatientsRisque()"><i class="bi bi-exclamation-triangle me-2"></i>Patients à risque</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-file-text me-2"></i>Rapports mensuels</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center" href="{{ url_for('cotation.grilles') }}">
                            <i class="bi bi-clipboard-check me-1" style="font-size:1.3rem;color:#fff;"></i>
                            <span>Cotations</span>
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    {% if current_user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            {{ current_user.email or 'Compte' }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li class="dropdown-item text-muted small">Connecté</li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Paramètres</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-question-circle me-2"></i>Aide</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}"><i class="bi bi-box-arrow-right me-2"></i>Déconnexion</a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('auth.login') }}">
                            <i class="bi bi-box-arrow-in-right me-1"></i> Connexion
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Messages Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show" role="alert">
                        <i class="bi bi-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Contenu principal -->
    <main class="container mt-4">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-muted">🎵 Synchronie</h6>
                    <p class="text-muted small mb-0">Musicothérapie intelligente - Révolutionner la pratique grâce à l'IA</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="text-muted small mb-0">Version 1.0.0</p>
                    <p class="text-muted small mb-0">
                        <i class="bi bi-shield-check me-1"></i>
                        Conforme RGPD
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <script>
    // Fonctions globales pour les analytics
    async function chargerAnalytics() {
        try {
            const response = await fetch('/cotation/analytics/dashboard');
            const data = await response.json();
            
            if (response.ok) {
                const analyticsModal = `
                    <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" onclick="fermerModal()">
                        <div class="modal-dialog modal-lg" onclick="event.stopPropagation()">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">📊 Statistiques globales</h5>
                                    <button type="button" class="btn-close" onclick="fermerModal()"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h3 class="text-primary">${data.nb_patients || 0}</h3>
                                                    <p class="mb-0">Patients actifs</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h3 class="text-success">${data.nb_grilles || 0}</h3>
                                                    <p class="mb-0">Grilles d'évaluation</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h3 class="text-info">${data.nb_cotations || 0}</h3>
                                                    <p class="mb-0">Cotations réalisées</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Score moyen</h6>
                                            <div class="progress">
                                                <div class="progress-bar" style="width: ${data.score_moyen || 0}%">${data.score_moyen || 0}%</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Évolution générale</h6>
                                            <p class="text-${data.evolution_positive ? 'success' : 'warning'}">
                                                <i class="bi bi-${data.evolution_positive ? 'arrow-up' : 'arrow-down'}"></i>
                                                ${data.evolution_positive ? 'Positive' : 'À surveiller'}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', analyticsModal);
            } else {
                alert('Erreur lors du chargement des statistiques');
            }
        } catch (error) {
            console.error('Erreur:', error);
            alert('Erreur de connexion aux analytics');
        }
    }

    async function chargerPatientsRisque() {
        try {
            const response = await fetch('/cotation/analytics/patients-risque');
            const data = await response.json();
            
            if (response.ok) {
                const patientsHtml = data.patients.map(patient => `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${patient.nom} ${patient.prenom}</strong>
                                    <small class="text-muted d-block">Score: ${patient.derniere_cotation.score_total}%</small>
                                </div>
                                <span class="badge bg-danger">${patient.niveau_risque}</span>
                            </div>
                        </div>
                    </div>
                `).join('') || '<p class="text-center text-muted">Aucun patient à risque détecté</p>';
                
                const risqueModal = `
                    <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" onclick="fermerModal()">
                        <div class="modal-dialog" onclick="event.stopPropagation()">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">⚠️ Patients à risque</h5>
                                    <button type="button" class="btn-close" onclick="fermerModal()"></button>
                                </div>
                                <div class="modal-body">
                                    ${patientsHtml}
                                </div>
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', risqueModal);
            } else {
                alert('Erreur lors du chargement des patients à risque');
            }
        } catch (error) {
            console.error('Erreur:', error);
            alert('Erreur de connexion aux analytics');
        }
    }

    function fermerModal() {
        const modals = document.querySelectorAll('.modal.show');
        modals.forEach(modal => modal.remove());
    }
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
