{% extends "base.html" %}

{% block title %}
    {% if grille %}
        Modifier {{ grille.nom }} - Synchronie
    {% else %}
        Nouvelle grille - Synchronie
    {% endif %}
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-0">
                    <i class="bi bi-clipboard-plus text-primary me-2"></i>
                    {% if grille %}
                        Modifier la grille
                    {% else %}
                        Nouvelle grille de cotation
                    {% endif %}
                </h1>
                <p class="text-muted mb-0">
                    {% if grille %}
                        Modifiez les paramètres de "{{ grille.nom }}"
                    {% else %}
                        Créez une grille personnalisée ou utilisez un template standard
                    {% endif %}
                </p>
            </div>
            <div>
                <a href="{{ url_for('grilles.list_grilles') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>
                    Retour aux grilles
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Choix du type de grille (seulement en création) -->
        {% if not grille %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-check me-2"></i>
                    Type de grille
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-primary template-choice" data-type="template">
                            <div class="card-body text-center">
                                <i class="bi bi-award text-primary" style="font-size: 2.5rem;"></i>
                                <h5 class="mt-3">Grille standard</h5>
                                <p class="text-muted">Utilisez une grille validée scientifiquement (AMTA, IMCAP-ND, etc.)</p>
                                <button type="button" class="btn btn-primary" onclick="choisirType('template')">
                                    Choisir un template
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-warning template-choice" data-type="custom">
                            <div class="card-body text-center">
                                <i class="bi bi-tools text-warning" style="font-size: 2.5rem;"></i>
                                <h5 class="mt-3">Grille personnalisée</h5>
                                <p class="text-muted">Créez votre propre grille adaptée à votre pratique clinique</p>
                                <button type="button" class="btn btn-warning" onclick="choisirType('custom')">
                                    Créer une grille
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Sélection de template (masqué par défaut) -->
        <div class="card border-0 shadow-sm mb-4" id="template-selection" style="display: none;">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-collection me-2"></i>
                    Choisir un template
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="templates-list">
                    <!-- Les templates seront chargés dynamiquement -->
                </div>
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-outline-secondary" onclick="retourChoixType()">
                        <i class="bi bi-arrow-left me-2"></i>
                        Retour
                    </button>
                </div>
            </div>
        </div>

        <!-- Formulaire de grille personnalisée -->
        <div class="card border-0 shadow-sm" id="custom-form" style="display: {% if grille %}block{% else %}none{% endif %};">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pencil me-2"></i>
                    {% if grille %}Configuration de la grille{% else %}Nouvelle grille personnalisée{% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form id="grille-form">
                    <!-- Informations générales -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <label for="nom" class="form-label">
                                Nom de la grille <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="nom" name="nom" 
                                   value="{% if grille %}{{ grille.nom }}{% endif %}" 
                                   required placeholder="Ex: Ma grille personnalisée">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="description" class="form-label">
                                Description
                            </label>
                            <textarea class="form-control" id="description" name="description" 
                                      rows="3" placeholder="Description de la grille et de son usage">{% if grille %}{{ grille.description }}{% endif %}</textarea>
                        </div>
                    </div>

                    <!-- Domaines d'évaluation -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">
                                <i class="bi bi-diagram-3 me-2"></i>
                                Domaines d'évaluation
                            </h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="ajouterDomaine()">
                                <i class="bi bi-plus-circle me-1"></i>
                                Ajouter un domaine
                            </button>
                        </div>
                        
                        <div id="domaines-container">
                            <!-- Les domaines seront ajoutés dynamiquement -->
                        </div>
                        
                        <div class="text-muted mt-2">
                            <small>
                                <i class="bi bi-info-circle me-1"></i>
                                Ajoutez au moins un domaine avec ses indicateurs d'évaluation
                            </small>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="text-end">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="annuler()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-2"></i>
                            {% if grille %}Mettre à jour{% else %}Créer la grille{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Template pour un domaine -->
<template id="domaine-template">
    <div class="card mb-3 domaine-card">
        <div class="card-header bg-light">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <input type="text" class="form-control domaine-nom" placeholder="Nom du domaine" required>
                </div>
                <div class="col-md-3">
                    <input type="color" class="form-control form-control-color domaine-couleur" value="#007bff" title="Couleur du domaine">
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control domaine-description" placeholder="Description courte">
                </div>
                <div class="col-md-1 text-end">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="supprimerDomaine(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">Indicateurs</h6>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="ajouterIndicateur(this)">
                    <i class="bi bi-plus me-1"></i>
                    Ajouter indicateur
                </button>
            </div>
            <div class="indicateurs-container">
                <!-- Les indicateurs seront ajoutés ici -->
            </div>
        </div>
    </div>
</template>

<!-- Template pour un indicateur -->
<template id="indicateur-template">
    <div class="row mb-2 indicateur-row">
        <div class="col-md-4">
            <input type="text" class="form-control indicateur-nom" placeholder="Nom de l'indicateur" required>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control indicateur-min" placeholder="Min" value="0" min="0">
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control indicateur-max" placeholder="Max" value="5" min="1">
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control indicateur-unite" placeholder="Unité (ex: points)" value="points">
        </div>
        <div class="col-md-1 text-end">
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="supprimerIndicateur(this)">
                <i class="bi bi-dash"></i>
            </button>
        </div>
    </div>
</template>

<script src="{{ url_for('static', filename='js/grille-form.js') }}"></script>
{% endblock %}
